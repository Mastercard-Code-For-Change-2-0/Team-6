<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Student Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="sidebar">
                <h2>Student Dashboard</h2>
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" data-tab="profile">Profile Management</a></li>
                    <li><a href="#" data-tab="documents">Document Upload</a></li>
                    <li><a href="#" data-tab="consent">Consent & Privacy</a></li>
                    <li><a href="/logout">Logout</a></li>
                </ul>
            </div>
            
            <div class="main-content">
                <div class="dashboard-header">
                    <h2>Welcome, <span id="student-name">Student</span></h2>
                    <div class="user-info">
                        <img src="https://via.placeholder.com/40" alt="Profile">
                        <span id="username-display">username</span>
                    </div>
                </div>
                
                <!-- Profile Management Tab -->
                <div class="tab-pane active" id="profile-tab">
                    <div class="card">
                        <h3>Profile Information</h3>
                        <div id="profile-success-message" class="success-message"></div>
                        <div id="profile-error-message" class="error-message"></div>
                        
                        <form id="profile-form">
                            <div class="form-group">
                                <label for="name">Full Name</label>
                                <input type="text" id="name" name="name" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" class="form-control">
                            </div>
                            
                            <div class="buttons">
                                <button type="submit" class="btn primary">Update Profile</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>Change Password</h3>
                        <div id="password-success-message" class="success-message"></div>
                        <div id="password-error-message" class="error-message"></div>
                        
                        <form id="password-form">
                            <div class="form-group">
                                <label for="current-password">Current Password</label>
                                <input type="password" id="current-password" name="currentPassword" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">New Password</label>
                                <input type="password" id="new-password" name="newPassword" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirm-password">Confirm New Password</label>
                                <input type="password" id="confirm-password" name="confirmPassword" class="form-control" required>
                            </div>
                            
                            <div class="buttons">
                                <button type="submit" class="btn primary">Change Password</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>Account Management</h3>
                        <p>Warning: Deactivating your account will prevent you from accessing the system. This action can only be reversed by an administrator.</p>
                        <div id="deactivate-success-message" class="success-message"></div>
                        <div id="deactivate-error-message" class="error-message"></div>
                        
                        <div class="buttons">
                            <button id="deactivate-account" class="btn secondary">Deactivate Account</button>
                        </div>
                    </div>
                </div>
                
                <!-- Document Upload Tab -->
                <div class="tab-pane" id="documents-tab">
                    <div class="card">
                        <h3>Upload New Document</h3>
                        <div id="upload-success-message" class="success-message"></div>
                        <div id="upload-error-message" class="error-message"></div>
                        
                        <form id="document-upload-form" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="document-type">Document Type</label>
                                <select id="document-type" name="type" class="form-control" required>
                                    <option value="">Select Document Type</option>
                                    <option value="certificate">Certificate</option>
                                    <option value="degree">Degree</option>
                                    <option value="id">ID Card</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="document-file">Select File</label>
                                <input type="file" id="document-file" name="document" class="form-control" required>
                                <small>Supported formats: PDF, JPG, PNG (Max size: 5MB)</small>
                            </div>
                            
                            <div class="buttons">
                                <button type="submit" class="btn primary">Upload Document</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>Your Documents</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Document Name</th>
                                        <th>Type</th>
                                        <th>Upload Date</th>
                                    </tr>
                                </thead>
                                <tbody id="documents-list">
                                    <!-- Documents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Consent & Privacy Tab -->
                <div class="tab-pane" id="consent-tab">
                    <div class="card">
                        <h3>Privacy & Consent Settings</h3>
                        <div id="consent-success-message" class="success-message"></div>
                        <div id="consent-error-message" class="error-message"></div>
                        
                        <form id="consent-form">
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="privacy-policy" name="privacy_accepted">
                                    I have read and agree to the Privacy Policy
                                </label>
                                <div class="consent-text">
                                    <h4>Privacy Policy</h4>
                                    <p>This Privacy Policy describes how your personal information is collected, used, and shared when you use our Student Management System.</p>
                                    <p>We collect personal information such as your name, email address, and documents you upload. This information is used to provide and improve our services to you.</p>
                                    <p>We may share your information with third parties only as described in this privacy policy.</p>
                                    <p>We use cookies and similar tracking technologies to track activity on our website and hold certain information.</p>
                                    <p>You have the right to access, update, or delete your personal information at any time.</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="terms-of-service" name="terms_accepted">
                                    I have read and agree to the Terms of Service
                                </label>
                                <div class="consent-text">
                                    <h4>Terms of Service</h4>
                                    <p>By using our Student Management System, you agree to these Terms of Service.</p>
                                    <p>You must not use our service for any illegal or unauthorized purpose.</p>
                                    <p>You are responsible for maintaining the security of your account and password.</p>
                                    <p>We reserve the right to modify or terminate the service for any reason, without notice at any time.</p>
                                    <p>We reserve the right to refuse service to anyone for any reason at any time.</p>
                                </div>
                            </div>
                            
                            <div class="buttons">
                                <button type="submit" class="btn primary">Save Consent Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Tab Navigation
        document.querySelectorAll('.sidebar-menu a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links and tabs
                document.querySelectorAll('.sidebar-menu a').forEach(item => item.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Show the corresponding tab
                const tabId = this.getAttribute('data-tab') + '-tab';
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Load user profile data
        async function loadProfile() {
            try {
                const response = await fetch('/api/profile');
                
                if (response.ok) {
                    const user = await response.json();
                    
                    // Update profile form
                    document.getElementById('name').value = user.name || '';
                    document.getElementById('email').value = user.email || '';
                    
                    // Update header
                    document.getElementById('student-name').textContent = user.name || 'Student';
                    document.getElementById('username-display').textContent = user.username || '';
                } else {
                    console.error('Failed to load profile');
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Update profile
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const successMessage = document.getElementById('profile-success-message');
            const errorMessage = document.getElementById('profile-error-message');
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMessage.textContent = data.message || 'Profile updated successfully';
                    errorMessage.textContent = '';
                    
                    // Update header
                    document.getElementById('student-name').textContent = name || 'Student';
                } else {
                    errorMessage.textContent = data.error || 'Failed to update profile';
                    successMessage.textContent = '';
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred. Please try again later.';
                successMessage.textContent = '';
                console.error('Profile update error:', error);
            }
        });
        
        // Change password
        document.getElementById('password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const successMessage = document.getElementById('password-success-message');
            const errorMessage = document.getElementById('password-error-message');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'New passwords do not match';
                successMessage.textContent = '';
                return;
            }
            
            try {
                const response = await fetch('/api/change-password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMessage.textContent = data.message || 'Password changed successfully';
                    errorMessage.textContent = '';
                    
                    // Clear form
                    document.getElementById('password-form').reset();
                } else {
                    errorMessage.textContent = data.error || 'Failed to change password';
                    successMessage.textContent = '';
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred. Please try again later.';
                successMessage.textContent = '';
                console.error('Password change error:', error);
            }
        });
        
        // Deactivate account
        document.getElementById('deactivate-account').addEventListener('click', async function() {
            if (!confirm('Are you sure you want to deactivate your account? This action can only be reversed by an administrator.')) {
                return;
            }
            
            const successMessage = document.getElementById('deactivate-success-message');
            const errorMessage = document.getElementById('deactivate-error-message');
            
            try {
                const response = await fetch('/api/deactivate-account', {
                    method: 'PUT'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMessage.textContent = data.message || 'Account deactivated successfully';
                    errorMessage.textContent = '';
                    
                    // Redirect to login after a delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                } else {
                    errorMessage.textContent = data.error || 'Failed to deactivate account';
                    successMessage.textContent = '';
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred. Please try again later.';
                successMessage.textContent = '';
                console.error('Account deactivation error:', error);
            }
        });
        
        // Document upload
        document.getElementById('document-upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const successMessage = document.getElementById('upload-success-message');
            const errorMessage = document.getElementById('upload-error-message');
            
            try {
                const response = await fetch('/api/upload-document', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMessage.textContent = data.message || 'Document uploaded successfully';
                    errorMessage.textContent = '';
                    
                    // Clear form
                    document.getElementById('document-upload-form').reset();
                    
                    // Reload documents list
                    loadDocuments();
                } else {
                    errorMessage.textContent = data.error || 'Failed to upload document';
                    successMessage.textContent = '';
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred. Please try again later.';
                successMessage.textContent = '';
                console.error('Document upload error:', error);
            }
        });
        
        // Load documents
        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                
                if (response.ok) {
                    const documents = await response.json();
                    const documentsList = document.getElementById('documents-list');
                    
                    // Clear existing list
                    documentsList.innerHTML = '';
                    
                    if (documents.length === 0) {
                        documentsList.innerHTML = '<tr><td colspan="3">No documents uploaded yet</td></tr>';
                        return;
                    }
                    
                    // Add documents to list
                    documents.forEach(doc => {
                        const row = document.createElement('tr');
                        
                        const nameCell = document.createElement('td');
                        nameCell.textContent = doc.filename;
                        
                        const typeCell = document.createElement('td');
                        typeCell.textContent = doc.type.charAt(0).toUpperCase() + doc.type.slice(1);
                        
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(doc.upload_date).toLocaleDateString();
                        
                        row.appendChild(nameCell);
                        row.appendChild(typeCell);
                        row.appendChild(dateCell);
                        
                        documentsList.appendChild(row);
                    });
                } else {
                    console.error('Failed to load documents');
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }
        
        // Load consent settings
        async function loadConsent() {
            try {
                const response = await fetch('/api/consent');
                
                if (response.ok) {
                    const consent = await response.json();
                    
                    document.getElementById('privacy-policy').checked = consent.privacy_accepted === 1;
                    document.getElementById('terms-of-service').checked = consent.terms_accepted === 1;
                } else {
                    console.error('Failed to load consent settings');
                }
            } catch (error) {
                console.error('Error loading consent settings:', error);
            }
        }
        
        // Save consent settings
        document.getElementById('consent-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const privacyAccepted = document.getElementById('privacy-policy').checked;
            const termsAccepted = document.getElementById('terms-of-service').checked;
            const successMessage = document.getElementById('consent-success-message');
            const errorMessage = document.getElementById('consent-error-message');
            
            try {
                const response = await fetch('/api/consent', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ privacy_accepted: privacyAccepted, terms_accepted: termsAccepted })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    successMessage.textContent = data.message || 'Consent settings saved successfully';
                    errorMessage.textContent = '';
                } else {
                    errorMessage.textContent = data.error || 'Failed to save consent settings';
                    successMessage.textContent = '';
                }
            } catch (error) {
                errorMessage.textContent = 'An error occurred. Please try again later.';
                successMessage.textContent = '';
                console.error('Consent settings error:', error);
            }
        });
        
        // Load data when page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            loadDocuments();
            loadConsent();
        });
    </script>
</body>
</html>